/**
 * Core Philosophy: This ruleset enforces a model where any authenticated user can access the data. This is suitable for single-user or development scenarios.
 *
 * Data Structure: The database has a primary top-level collection: `/technicians`. Each technician document contains subcollections for `serviceRecords`, `todos`, `calendarEvents`, etc.
 *
 * Key Security Decisions:
 * - Open Access for Authenticated Users: To simplify development and for single-technician use cases, any signed-in user is granted read and write access to the data. This removes the need for strict ownership checks for each operation.
 * - Data Integrity: While access is open for authenticated users, some basic data integrity is maintained, for example, by checking for the presence of a `technicianId` on creation.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is signed in.
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Controls access to technician profile documents.
     * @allow Any authenticated user can manage technician profiles.
     */
    match /technicians/{technicianId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Controls access to customer profile documents.
     * @allow Any authenticated user can manage customer profiles.
     */
    match /customers/{customerId} {
      allow read, write: if isSignedIn();
    }

    /**
     * @description Controls access to a technician's view of service records.
     * @allow Any authenticated user can manage service records.
     */
    match /technicians/{technicianId}/serviceRecords/{serviceRecordId} {
      allow get, write: if isSignedIn();
    }
    match /technicians/{technicianId}/serviceRecords {
        allow list: if isSignedIn();
    }

    /**
     * @description Controls access to a customer's view of service records.
     * @allow Any authenticated user can manage service records.
     */
    match /customers/{customerId}/serviceRecords/{serviceRecordId} {
       allow get, write: if isSignedIn();
    }
     match /customers/{customerId}/serviceRecords {
        allow list: if isSignedIn();
    }
    
    /**
     * @description Controls access to a technician's to-do items.
     * @allow Any authenticated user can manage their to-do items.
     */
    match /technicians/{technicianId}/todos/{todoId} {
      allow get, write: if isSignedIn();
    }
    match /technicians/{technicianId}/todos {
        allow list: if isSignedIn();
    }

    /**
     * @description Controls access to a technician's calendar events.
     * @allow Any authenticated user can manage their calendar events.
     */
    match /technicians/{technicianId}/calendarEvents/{eventId} {
        allow get, write: if isSignedIn();
    }
    match /technicians/{technicianId}/calendarEvents {
        allow list: if isSignedIn();
    }

    /**
     * @description Controls access to a technician's expense records.
     * @allow Any authenticated user can manage their expense records.
     */
    match /technicians/{technicianId}/expenses/{expenseId} {
      allow get, write: if isSignedIn();
    }
     match /technicians/{technicianId}/expenses {
      allow list: if isSignedIn();
    }

    /**
     * @description Controls access to a technician's price book entries.
     * @allow Any authenticated user can manage their price book.
     */
    match /technicians/{technicianId}/priceBookEntries/{entryId} {
      allow get, write: if isSignedIn();
    }
    match /technicians/{technicianId}/priceBookEntries {
      allow list: if isSignedIn();
    }
  }
}
